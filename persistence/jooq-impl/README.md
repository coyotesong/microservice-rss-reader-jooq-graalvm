# Persistence using jOOQ

This module contains an implementation of the RSS Persistence SPI using the jOOQ library.

## Custom Bindings

jOOQ supports custom data transformation. You would use a
[Binding](https://www.jooq.org/doc/latest/manual/sql-building/queryparts/custom-bindings/) if you
want to implement an extension to the database. A common example is a bindig that allows your POJO to use
[UUID](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/UUID.html)s even if the
database doesn't support that type. If you don't need this level of integration you can use a
[Converter](https://www.jooq.org/doc/latest/manual/sql-execution/fetching/data-type-conversion/).

This repo contains the following bindings:

- **LocalDateTimeToInstantBinding** - mapping
  between [Instant](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/time/Instant.html)
  and `TIMESTAMP(x) WITHOUT TIME ZONE`
- **TimestampInstantBinding** - mapping
  between [Instant](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/time/Instant.html) and `TIMESTAMP`
- **VarcharToURLBinding** - mapping
  between [URL](https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/net/URL.html) and `VARCHAR` or `TEXT`
- **VarcharToUUIDBinding** - mapping
  between [UUID]()https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/UUID.html) and `VARCHAR`
  or `TEXT`

## Code Autogeneration

jOOQ has some support for
the [Jakarta @Column](https://jakartaee.github.io/persistence/latest/api/jakarta.persistence/jakarta/persistence/Column.html)

This project uses [TestContainers](https://testcontainers.org/), [Flyway](https://flywaydb.org/), and the
[testcontainers-jooq-codegen-maven-plugin](https://github.com/testcontainers/testcontainers-jooq-codegen-maven-plugin)
plugin to generate most of the jOOQ-related code. The autogenerated code is written to a new maven source
directory: `src/main/java.jooq`.

### Usage

1. Add the RSS schemas to `src/test/main/db/resources`. They should be named 'V#__do-some-task.sql'. It is not enough
   for them in the classpath - they must be in this source tree.
2. Run `$ mvn -P codegen generate-sources`.
3. Run `$ mvn install` as usual.

### Resources

- [build-helper-maven-plugin](build-helper-maven-plugin)
- [testcontainers-jooq-codegen-maven-plugin](https://github.com/testcontainers/testcontainers-jooq-codegen-maven-plugin)
- [Working with jOOQ and Flyway using TestContainers](https://testcontainers.com/guides/working-with-jooq-flyway-using-testcontainers/)
- 